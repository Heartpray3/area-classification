================================================================================
ANALYSE COMPLÈTE DES FEATURES CRÉÉES
================================================================================
Alignement avec le sujet du cours ML : geographical features + pipeline
(Preprocessing, feature engineering, réduction de dimension / sélection)

================================================================================
1. RAPPEL DU SUJET : DONNÉES GÉOGRAPHIQUES ET PIPELINE
================================================================================

Les données géographiques décrites dans le sujet sont :
  (a) Un polygone irrégulier.
  (b) Des valeurs catégorielles décrivant le statut du polygone sur cinq dates
      (ex. en construction à la date 1, construction terminée les quatre dates suivantes).
  (c) Caractéristiques urbaines du voisinage (ex. zone urbaine dense et industrielle).
  (d) Caractéristiques géographiques du voisinage (ex. proche d'une rivière et d'une colline).

Pipeline demandé :
  - Preprocessing : prétraiter les données et les convertir au format approprié.
  - Feature engineering et réduction de dimension : explorer la création d’un nouvel
    ensemble (éventuellement plus petit) de features ; réduction de dimension ;
    sélection d’un sous-ensemble de features. Idées explicites :
    * Urban and Geographical types : colonnes catégorielles multi-valuées
      → one-hot encoding recommandé.
    * Polygones irréguliers : area, perimeter, ou toute autre propriété géométrique.
    * Nombre de jours entre deux dates consécutives : utile.

================================================================================
2. PREPROCESSING (FORMAT ET NETTOYAGE)
================================================================================

Script : preprocess_features.py. Entrées : train.geojson, test.geojson.
Sorties : train_features.parquet, test_features.parquet (DataFrames prêts pour le ML).

Étapes effectuées :
  2.1 Chargement GeoJSON (geopandas), CRS fixé à EPSG 4326 si absent.
  2.2 Suppression des lignes sans géométrie (geometry isna) ou à géométrie vide (is_empty).
  2.3 Réparation des géométries invalides : make_valid(geom) pour chaque géométrie.
  2.4 Géométries avec coordonnées NaN/Inf : remplacement par un point sûr Point(0,0)
      (ligne conservée ; les features spatiales dérivées seront 0 pour ces lignes).
  2.5 Renommage des colonnes img_*_date1..5 → img_*_date0..4 (process_columns).
  2.6 Réordonnancement temporel (reorder_dates) :
      - Les 5 colonnes date0..date4 sont triées par date croissante.
      - Tous les blocs liés (img_*_date0..4, change_status_date0..4, etc.) sont
        réordonnés de façon cohérente selon ce tri.
      - Pour les lignes avec au moins une date non NaN, forward-fill sur
        change_status_date0..4 pour propager le dernier statut connu.
  2.7 En sortie, suppression uniquement des colonnes "index" et "geometry" ;
      le reste (y compris change_status_date0..4 et toutes les features dérivées)
      est conservé dans le Parquet.

================================================================================
3. FEATURES CRÉÉES – INVENTAIRE EXHAUSTIF
================================================================================

Les features sont construites dans preprocess_geojson() et écrites dans le DataFrame
final (puis Parquet). Le script train.py les regroupe pour l’entraînement (voir section 5).

--------------------------------------------------------------------------------
3.A POLYGONE IRRÉGULIER (GEOMETRY)
--------------------------------------------------------------------------------
Référence sujet : "Irregular polygons can be processed in several ways to create
features: the area, the perimeter, or any other geometrical property of a polygon."

Calcul : géométrie projetée en UTM (estimate_utm_crs()) pour obtenir des grandeurs
en mètres. Toutes les features ci-dessous sont calculées sur cette géométrie.

  Nom de la feature    | Description
  ---------------------|----------------------------------------------------------
  area_sqm             | Aire du polygone (m²).
  perimeter_m          | Périmètre (m).
  compactness         | (4 * pi * area_sqm) / (perimeter_m^2) ; 0 si perimeter_m = 0.
  length_m            | Longueur du rectangle minimum tournant (minimum rotated
                       | rectangle), en m.
  width_m             | Largeur du même rectangle, en m.
  aspect_ratio        | length_m / width_m ; 0 si width_m = 0.
  centroid_lon        | Longitude du centroïde (géométrie WGS84).
  centroid_lat        | Latitude du centroïde (géométrie WGS84).
  convex_area         | Aire de l’enveloppe convexe (m²) ; safe_convex_area pour
                       | éviter les crashs GEOS (NaN/Inf → 0).
  bbox_height         | Hauteur de la bbox (maxy - miny) en m.
  bbox_width          | Largeur de la bbox (maxx - minx) en m.
  num_vertices       | Nombre de sommets (exterior.coords pour Polygon, somme sur
                       | les parties pour MultiPolygon).
  max_radius          | Distance du centroïde au boundary (hausdorff_distance),
                       | en m.

Total : 13 features géométriques.

--------------------------------------------------------------------------------
3.B STATUT DU POLYGONE SUR CINQ DATES (CATÉGORIEL)
--------------------------------------------------------------------------------
Référence sujet : "Categorical values describing the status of the polygon on five
different dates."

  (B1) Colonnes brutes conservées après reorder_dates :
       change_status_date0, change_status_date1, change_status_date2,
       change_status_date3, change_status_date4.
       (Ces colonnes ne sont pas utilisées comme features numériques dans train.py
       ; elles sont encodées via les features ci-dessous.)

  (B2) One-hot du statut par date (add_status_onehots_per_date) :
       Pour chaque date i in {0,1,2,3,4} et chaque statut s dans ALL_STATUSES,
       une colonne binaire : status_<s>_date<i>.
       Statuts (ALL_STATUSES) : Greenland, Land Cleared, Prior Construction,
       Excavation, Materials Dumped, Materials Introduced, Construction Started,
       Construction Midway, Construction Done, Operational.
       Nombre de colonnes : 10 statuts × 5 dates = 50 colonnes.

  (B3) Features dérivées du statut et du temps (process_time_between_statuses et
       process_timeline) — détaillées en 3.D et 3.E.

--------------------------------------------------------------------------------
3.C CARACTÉRISTIQUES URBAINES DU VOISINAGE (NEIGHBOURHOOD URBAN)
--------------------------------------------------------------------------------
Référence sujet : "Neighbourhood urban features (e.g., the polygon is in a dense
urban and industrial region)." + "Urban and Geographical types are multi-valued
categorical columns (one-hot encoding could be helpful)."

  (C1) One-hot multi-valued (one_hot_tags, colonne urban_type) :
       urban_type peut contenir plusieurs tags séparés par des virgules. Les tags
       considérés sont : Dense Urban, Sparse Urban, Industrial, Rural, Urban Slum.
       Pour chaque tag, une colonne binaire : urban_Dense_Urban, urban_Sparse_Urban,
       urban_Industrial, urban_Rural, urban_Urban_Slum.
       Gestion spéciale : "N,A" est traité comme un tag unique (pas de split) ;
       les espaces sont stripés.
       Nombre de colonnes : 5.

  (C2) Features dérivées urbaines (add_urban_geo_features, à partir de urban_type) :
       urban_density_score : score ordinal 0–4 (Rural=0, N,A=1, Urban Slum=2,
                             Sparse Urban=3, Dense Urban/Industrial=4) ; si plusieurs
                             tags, on prend le max.
       n_urban_tags        : nombre de tags dans urban_type (0 si vide ou "N,A").
       is_rural            : 1 si "Rural" présent dans urban_type, 0 sinon.

--------------------------------------------------------------------------------
3.D CARACTÉRISTIQUES GÉOGRAPHIQUES DU VOISINAGE (NEIGHBOURHOOD GEOGRAPHIC)
--------------------------------------------------------------------------------
Référence sujet : "Neighbourhood geographic features (e.g., the polygon is near a
river and a hill)." + one-hot pour types géographiques multi-valués.

  (D1) One-hot multi-valued (one_hot_tags, colonne geography_type) :
       Tags : Sparse Forest, Grass Land, Dense Forest, Farms, Barren Land, Lakes,
       River, Coastal, Desert, Hills, Snow.
       Colonnes : geo_Sparse_Forest, geo_Grass_Land, geo_Dense_Forest, geo_Farms,
       geo_Barren_Land, geo_Lakes, geo_River, geo_Coastal, geo_Desert, geo_Hills,
       geo_Snow.
       Nombre de colonnes : 11.

  (D2) Features dérivées géographiques (add_urban_geo_features, à partir de
       geography_type) :
       n_geo_tags      : nombre de tags dans geography_type (0 si vide ou "N,A").
       has_water       : 1 si au moins un de "River", "Lakes", "Coastal" présent, 0 sinon.
       has_dense_forest: 1 si "Dense Forest" présent, 0 sinon.
       has_farms       : 1 si "Farms" présent, 0 sinon.

--------------------------------------------------------------------------------
3.E NOMBRE DE JOURS ENTRE DEUX DATES CONSÉCUTIVES (ET TEMPS LIÉ AU STATUT)
--------------------------------------------------------------------------------
Référence sujet : "The number of days between two consecutive dates could also be
helpful."

Toutes les features ci-dessous sont calculées après tri chronologique des dates
(date0..date4 et blocs associés déjà réordonnés). Deux représentations sont utilisées :
  - "timeline" : liste des (date, change_status) pour les 5 dates (brute).
  - "comp" : timeline compressée en fusionnant les statuts identiques consécutifs.

  (E1) process_time_between_statuses – durée et délais :
       timeline_len           : nombre de points distincts dans la timeline compressée
                                (après fusion des statuts identiques consécutifs).
       total_duration_days    : nombre de jours entre la première et la dernière date
                                (comp).
       delta_days_1, delta_days_2, delta_days_3, delta_days_4 :
                                jours entre deux points consécutifs de la timeline
                                compressée (delta_days_k = date_{k} - date_{k-1} dans comp).
       days_to_<status>       : pour chaque statut s dans ALL_STATUSES, nombre de jours
                                depuis la première date (comp) jusqu’à la première
                                occurrence de s ; -1.0 si le statut n’apparaît pas.
                                Colonnes : days_to_Greenland, days_to_Land_Cleared,
                                days_to_Prior_Construction, days_to_Excavation,
                                days_to_Materials_Dumped, days_to_Materials_Introduced,
                                days_to_Construction_Started, days_to_Construction_Midway,
                                days_to_Construction_Done, days_to_Operational.
                                Nombre : 10.

  (E2) Jours entre dates consécutives – avec ou sans changement de statut :
       change_status_frequency : nombre d’intervalles (date_i → date_i+1) dans la
                                 timeline brute où le statut change (entier 0 à 4).
       days_if_change_0_1, days_if_change_1_2, days_if_change_2_3, days_if_change_3_4 :
                                 pour l’intervalle entre date_i et date_i+1 : 0 si le
                                 statut ne change pas ; sinon nombre de jours entre
                                 les deux dates. Exactement ce que demande le sujet
                                 pour "jours entre deux dates consécutives" quand
                                 on veut distinguer "avec changement" vs "sans".

  (E3) Phase et transitions (process_time_between_statuses) :
       phase_days_pre, phase_days_site_prep, phase_days_materials,
       phase_days_construction, phase_days_post :
                                pour chaque phase (pre, site_prep, materials,
                                construction, post), somme des durées (en jours) passées
                                dans un statut de cette phase entre deux points consécutifs
                                de comp.
       prior_construction_present         : 1 si "Prior Construction" apparaît dans comp.
       prior_construction_before_cleared  : 1 si "Prior Construction" apparaît avant
                                            "Land Cleared" dans comp, 0 sinon.
       tr_<status_a>_to_<status_b>       : comptage des transitions de status_a vers
                                            status_b entre points consécutifs de comp.
                                            Une colonne par paire (a,b) dans ALL_STATUSES :
                                            10 × 10 = 100 colonnes (souvent très sparse).

  (E4) process_timeline – résumés temporels et progression :
       work_duration_days       : jours entre la première et la dernière date où le
                                 statut est dans la "construction" (rank 30–90).
       status_rank_max         : max des rangs de statut (STATUS_RANK_MAP) sur la
                                 timeline.
       status_progression_delta : rang du dernier statut − rang du premier.
       unique_status_count     : nombre de statuts distincts dans la timeline.
       avg_days_between_status : total_duration_days / (len(timeline)-1) si len>1, 0 sinon.

--------------------------------------------------------------------------------
3.F FEATURES IMAGE / TIMELINE (PAR DATE T1..T5 ET DELTAS)
--------------------------------------------------------------------------------
Dérivées des canaux image (R, G, B) et statut à chaque date, après tri chronologique
(process_timeline). Utilisent img_red_mean_date{i}, img_green_mean_date{i},
img_blue_mean_date{i}, img_*_std_date{i} pour i dans la timeline triée (t1 = 1er
point temporel, …, t5 = 5e si présent).

  (F1) Par point temporel t1..t5 (jusqu’à 5 points) :
       img_red_mean_t<j>, img_green_mean_t<j>, img_blue_mean_t<j>,
       img_red_std_t<j>, img_green_std_t<j>, img_blue_std_t<j>,
       brightness_t<j>  = 0.299*R + 0.587*G + 0.114*B,
       texture_t<j>     = moyenne des std R,G,B,
       exg_t<j>         = 2*G - R - B,
       exr_t<j>         = 1.4*R - G,
       saturation_t<j>  = (max(R,G,B)-min(R,G,B)) / (max(R,G,B)+eps).
       j in {1,2,3,4,5}. Donc 11 métriques × 5 = 55 colonnes (beaucoup à 0 si
       moins de 5 dates).

  (F2) Deltas entre premier et dernier point temporel (process_timeline) :
       delta_brightness, delta_texture, delta_exg, delta_saturation, delta_exr :
       valeur au dernier point (t_last) − valeur au premier (t1).

================================================================================
4. CORRESPONDANCE AVEC LES IDÉES DU SUJET
================================================================================

  Sujet                              | Implémentation dans le pipeline
  -----------------------------------|------------------------------------------
  One-hot pour Urban types           | 3.C : urban_* (5 colonnes) + dérivées
  One-hot pour Geographical types    | 3.D : geo_* (11 colonnes) + dérivées
  Area, perimeter, propriétés        | 3.A : area_sqm, perimeter_m, compactness,
  géométriques du polygone           |       length_m, width_m, aspect_ratio,
                                      |       centroid_*, convex_area, bbox_*,
                                      |       num_vertices, max_radius
  Jours entre deux dates             | 3.E : delta_days_1..4 (comp), total_duration_days,
  consécutives                       |       days_if_change_0_1..3_4 (avec/sans changement),
                                      |       phase_days_*, days_to_<status>, etc.

En plus du sujet : statut sur 5 dates encodé (3.B), transitions entre statuts (3.E3),
résumés de progression (3.E4), et features image par date (3.F) pour exploiter
l’évolution temporelle du site.

================================================================================
5. UTILISATION DANS train.py (GROUPES DE FEATURES)
================================================================================

Le script train.py charge les Parquet et sélectionne les colonnes par groupes.
Seules les colonnes numériques et présentes à la fois dans train et test sont
utilisées. Alignement avec les sections ci-dessus :

  Groupe dans train.py   | Contenu (référence section)
  -----------------------|------------------------------------------
  GEOM_COLS              | 3.A : 13 features géométriques listées explicitement.
  ONEHOT_COLS            | 3.C1 + 3.D1 : urban_* et geo_* (préfixes urban_/geo_,
                         |               sans colonnes se terminant par _tag_count).
  URB_GEO_COLS           | 3.C2 + 3.D2 : urban_density_score, n_urban_tags, n_geo_tags,
                         |               has_water, has_dense_forest, has_farms, is_rural.
  IMG_COLS               | 3.F : colonnes dont le nom commence par les patterns
                         |       img_red_mean_t, img_green_mean_t, ..., exr_t, et
                         |       delta_brightness, delta_texture, delta_exg,
                         |       delta_saturation, delta_exr.
  TIME_COLS              | 3.E : timeline_len, total_duration_days, change_status_frequency ;
                         |       work_duration_days, status_rank_max, status_progression_delta,
                         |       unique_status_count, avg_days_between_status ;
                         |       tout préfixe days_to_, delta_days_, phase_days_,
                         |       prior_construction_*, tr_*, days_if_change_*.
  STATUS_FLAG_COLS       | 3.B2 : status_*_date* (one-hot statut par date).

FEATURE_COLS = GEOM_COLS + ONEHOT_COLS + URB_GEO_COLS + IMG_COLS + TIME_COLS + STATUS_FLAG_COLS.
Après alignement train/test, remplissage des NaN/Inf (clip + fillna(0)), et conversion
en numpy float32 pour l’entraînement XGBoost.

================================================================================
6. RÉSUMÉ QUANTITATIF (ORDRE DE GRANDEUR)
================================================================================

  Catégorie                    | Nombre de features (ordre)
  -----------------------------|----------------------------
  Géométrie (polygone)         | 13
  One-hot urban                | 5
  One-hot geo                  | 11
  Dérivées urban/geo           | 7
  Statut one-hot par date      | 50
  Temps / jours / phases       | ~10 + 4 + 5 + 2 + 10 + 100 + 5 + 4 + … (nombreux)
  Image t1..t5 + deltas        | 55 + 5
  -----------------------------|----------------------------
  Total (avant sélection)      | Plusieurs centaines de colonnes utilisées en entrée
                              | (train.py filtre selon les groupes ci-dessus).

================================================================================
FIN DE L’ANALYSE
================================================================================
